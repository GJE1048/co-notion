# 系统架构设计

## 整体架构

智能化多人文档编辑平台采用前后端分离架构，前端基于 React/Next.js，后端基于 Node.js，采用微服务设计理念，将系统拆分为多个独立的服务模块。

## 技术栈架构

### 前端技术栈
- **框架**: Next.js 14+ (App Router)
- **语言**: TypeScript
- **UI库**: shadcn/ui + Tailwind CSS
- **状态管理**: Zustand / Redux Toolkit
- **实时通信**: Socket.io-client
- **富文本编辑器**: Slate.js / Quill.js (支持协同编辑)

### 后端技术栈
- **运行时**: Node.js
- **框架**: Express.js / Fastify
- **语言**: TypeScript
- **数据库**: PostgreSQL + Prisma ORM
- **缓存**: Redis
- **实时通信**: Socket.io
- **认证**: JWT + Session
- **API文档**: Swagger/OpenAPI

### AI集成
- **模型**: OpenAI GPT-4 / Claude / 通义千问
- **集成方式**: RESTful API + WebSocket
- **功能**: 文本续写、润色、翻译、摘要生成、智能问答

## 系统模块架构

```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面层 (UI Layer)                      │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  文档编辑器  │  AI助手面板 │  文档管理器 │  用户管理界面   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────┐
│                 业务逻辑层 (Business Logic Layer)            │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 实时协同编辑│   AI智能辅助  │ 可视化文档管理│权限与安全控制│ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据访问层 (Data Access Layer)             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │   用户数据   │   文档数据   │   版本历史   │   权限数据    │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────┐
│                   基础设施层 (Infrastructure Layer)          │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  PostgreSQL │   Redis    │   WebSocket  │    文件存储    │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. 实时协同编辑模块

**整体思路**:
- 以 Block 为最小编辑单元（类似 Notion）
- 使用 Yjs 提供的 CRDT 能力管理 Block 列表和 Block 内容
- 通过 WebSocket 进行增量同步和在线状态广播
- 后端定期将 Yjs 状态持久化到数据库

**核心数据结构（Yjs 层）**:

- 顶层使用 `Y.Doc` 表示一份文档的协同状态
- 使用 `Y.Array<Y.Map>` 表示 Block 列表，保持顺序和可插入/删除
- 每个 Block 使用 `Y.Map` 表示，可按字段级别进行 CRDT 合并

示例结构：

```ts
// Y.Doc 根结构
const ydoc = new Y.Doc();
const yBlocks = ydoc.getArray<Y.Map<unknown>>("blocks");

// 单个 Block
const block = new Y.Map<unknown>();
block.set("id", "blk_1");
block.set("type", "paragraph");
block.set("content", new Y.Text("Hello world"));
block.set("props", { color: "red" });

yBlocks.push([block]);
```

**协议与服务组件**:
- 协同协议：基于 WebSocket 的二进制增量同步（Yjs 更新包）
- WebSocket 服务：Node.js + `ws` / `y-websocket`
- 在线状态与光标：使用 Yjs Awareness 协议广播 `presence` 和 `cursor` 信息
- 后端持久化：周期性将 `Y.encodeStateAsUpdate(ydoc)` 的结果写入 PostgreSQL

**与 Block 数据模型的关系**:
- 数据库中的 `blocks` 表负责：
  - 为 Block 提供稳定的 ID、类型、排序字段等元数据
  - 支持基于 Block 的查询和权限控制
- Yjs 文档负责：
  - 在内存中维护 Block 列表及内容的实时协同状态
  - 自动解决并发写入冲突
  - 提供离线编辑和自动恢复能力

**架构特点**:
- 支持多用户并发编辑同一文档、多 Block 同时编辑
- Block 粒度的 CRDT 合并，避免整篇文档冲突
- 通过增量更新降低网络流量
- 光标、选区和在线状态实时同步

### 2. AI智能写作辅助模块

**功能架构**:
```
用户请求 → 输入预处理 → AI模型调用 → 结果后处理 → 实时同步
```

**集成方式**:
- **触发机制**: 文本选择 + 快捷键 / 右键菜单
- **API设计**: RESTful + Streaming API
- **缓存策略**: Redis缓存常用结果
- **错误处理**: 降级策略 + 重试机制

### 3. 可视化文档管理模块

**数据结构**:
- **文档树**: 多叉树结构
- **标签系统**: 多对多关系
- **关系图谱**: 图数据库 (Neo4j 可选)
- **搜索索引**: Elasticsearch

**界面设计**:
- 文件夹层级导航
- 拖拽式文件管理
- 关系图谱可视化
- 全文搜索界面

### 4. 用户权限与安全控制模块

**权限模型**:
```
权限等级: 所有者 > 管理员 > 编辑者 > 评论者 > 查看者
```

**安全机制**:
- **认证**: JWT + 双因子认证
- **授权**: RBAC (Role-Based Access Control)
- **审计**: 操作日志记录
- **加密**: 数据传输加密 + 存储加密

### 5. 系统基础服务模块

**服务架构**:
- **用户服务**: 注册、登录、资料管理
- **文档服务**: CRUD操作、版本控制
- **通知服务**: 实时通知、邮件推送
- **监控服务**: 系统监控、性能指标

## 部署架构

### 开发环境
```
本地开发 → Docker Compose → PostgreSQL + Redis + Node.js
```

### 生产环境
```
Nginx (负载均衡) → Node.js 应用集群 → PostgreSQL 主从 → Redis 集群
```

### 云服务架构
```
用户 → CDN → API Gateway → 微服务集群 → 数据库集群
```

## 扩展性考虑

1. **水平扩展**: 支持多实例部署
2. **模块化设计**: 便于功能扩展
3. **插件系统**: 支持第三方扩展
4. **API版本控制**: 向后兼容性保证

## 性能优化策略

1. **前端优化**: 代码分割、懒加载、虚拟滚动
2. **后端优化**: 缓存策略、数据库索引、连接池
3. **网络优化**: WebSocket压缩、CDN加速
4. **AI优化**: 请求合并、结果缓存、智能预加载
